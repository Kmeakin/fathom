extern crate ddl_util;

use std::io;
use std::io::prelude::*;

/// https://en.wikipedia.org/wiki/STL_(file_format)
#[derive(Debug, Clone)]
pub struct Stl {
    /// Generally ignored
    pub header: Vec<u8>,
    /// Number of triangles that follow
    pub num_triangles: u32,
    /// The triangle data
    pub triangles: Vec<Triangle>,
}

impl Stl {
    pub fn read<R: Read>(reader: &mut R) -> io::Result<Stl> {
        let header = (0..80u8).map(|_| ddl_util::from_u8(reader)).collect::<Result<_, _>>()?;
        let num_triangles = ddl_util::from_u32le(reader)?;
        let triangles =
        (0..num_triangles).map(|_| Triangle::read(reader)).collect::<Result<_, _>>()?;
        Ok::<_, io::Error>(Stl {
            header: header,
            num_triangles: num_triangles,
            triangles: triangles,
        })
    }
}

#[derive(Debug, Clone)]
pub struct Triangle {
    /// Normal vector
    pub normal: Vec3d,
    /// Coordinates of the vertices
    pub vertices: Vec<Vec3d>,
    /// Attribute byte count
    ///
    /// The attribute syntax is not documented in the formal specification. It is
    /// specified that the attribute byte count should be set to zero.
    pub attribute_bytes: u16,
}

impl Triangle {
    pub fn read<R: Read>(reader: &mut R) -> io::Result<Triangle> {
        let normal = Vec3d::read(reader)?;
        let vertices = (0..3u8).map(|_| Vec3d::read(reader)).collect::<Result<_, _>>()?;
        let attribute_bytes = ddl_util::from_u16le(reader)?;
        Ok::<_, io::Error>(Triangle {
            normal: normal,
            vertices: vertices,
            attribute_bytes: attribute_bytes,
        })
    }
}

#[derive(Debug, Clone)]
pub struct Vec3d {
    pub x: f32,
    pub y: f32,
    pub z: f32,
}

impl Vec3d {
    pub fn read<R: Read>(reader: &mut R) -> io::Result<Vec3d> {
        let x = ddl_util::from_f32le(reader)?;
        let y = ddl_util::from_f32le(reader)?;
        let z = ddl_util::from_f32le(reader)?;
        Ok::<_, io::Error>(Vec3d {
            x: x,
            y: y,
            z: z,
        })
    }
}


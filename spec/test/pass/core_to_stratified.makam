%extend core_to_stratified.

    %open fathom.lang.


    tests : testsuite.
    %testsuite tests.


% FIXME: there seems to be a bug with indenting tests here - see https://github.com/astampoulis/makam/issues/94

    % Conversion

>> from_term_to_kind core.type_type Target ?
>> Yes:
>> Target := stratified.type_type.

>> from_term_to_kind (core.record_type []) Target ?
>> Impossible.

>> from_term_to_kind (core.record_intro []) Target ?
>> Impossible.

>> from_term_to_type (core.record_type []) Target ?
>> Yes:
>> Target := stratified.record_type [].

>> from_term_to_type (core.record_intro []) Target ?
>> Impossible.

>> from_term_to_term (core.record_intro []) Target ?
>> Yes:
>> Target := stratified.record_intro [].


    % Variables

>> from_term (context [kind, type']) (core.local 0) Target ?
>> Yes:
>> Target := type' (stratified.local 0).

>> from_term (context [kind, type']) (core.local 1) Target ?
>> Yes:
>> Target := term (stratified.local 1).


    % Annotated terms

>> from_term (core.ann core.int_type core.type_type) Target ?
>> Yes:
>> Target := type' (stratified.ann stratified.int_type stratified.type_type).

>> from_term (core.ann core.format_intro_u8 core.format_type) Target ?
>> Yes:
>> Target := type' (stratified.ann stratified.format_intro_u8 stratified.format_type).

>> from_term (core.ann (core.record_intro []) (core.record_type [])) Target ?
>> Yes:
>> Target := term (stratified.ann (stratified.record_intro []) (stratified.record_type [])).


    % Universes

>> from_term core.type_type Target ?
>> Yes:
>> Target := kind stratified.type_type.


    % Functions
    % Pairs


    % Records

>> from_term (core.record_type []) Target ?
>> Yes:
>> Target := type' (stratified.record_type []).

>> from_term
    (core.record_type
        [ ( "len", core.int_type )
        , ( "data", core.array_type (core.record_type []) (core.local 0) )
        ])
    Target ?
>> Yes:
>> Target := type'
    (stratified.record_type
        [ ( "len", stratified.int_type )
        , ( "data", stratified.array_type (stratified.record_type []) (stratified.local 0) )
        ]).

>> from_term (core.record_intro []) Target ?
>> Yes:
>> Target := term (stratified.record_intro []).

>> from_term
    (core.record_intro
        [ ( "data", core.array_intro [ core.record_intro [], core.record_intro [] ])
        , ( "len", core.int_intro 2 )
        ])
    Target ?
>> Yes:
>> Target := term
    (stratified.record_intro
        [ ( "data",
            stratified.array_intro
                [ stratified.record_intro []
                , stratified.record_intro []
                ]
          )
        , ( "len", stratified.int_intro 2 )
        ]).

    % TODO: Test record elimination


    % Enumerations
    % Integers
    % Arrays


    % Binary format descriptions

>> from_term (core.format_intro_unit) Target ?
>> Yes:
>> Target := type' (stratified.format_intro_unit).

>> from_term (core.format_intro_u8) Target ?
>> Yes:
>> Target := type' (stratified.format_intro_u8).

>> from_term (core.format_intro_record []) Target ?
>> Yes:
>> Target := type' (stratified.format_intro_record []).

>> from_term (core.format_intro_array (core.format_intro_record []) (core.int_intro 3)) Target ?
>> Yes:
>> Target := type'
    (stratified.format_intro_array
        (stratified.format_intro_record [])
        (stratified.int_intro 3)).

>> from_term
    (core.format_intro_record
        [ ( "len", core.format_intro_u32be )
        , ( "data", core.format_intro_array (core.format_intro_record []) (core.local 0) )
        ])
    Target ?
>> Yes:
>> Target := type'
    (stratified.format_intro_record
        [ ( "len", stratified.format_intro_u32be )
        , ( "data"
          , stratified.format_intro_array
                (stratified.format_intro_record [])
                (stratified.local 0)
          )
        ]).

%end.
